<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>교가때리기 게임하기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    /* ... (기존 CSS 유지) ... */
  </style>
</head>
<body>
  <h1>교가때리기 게임하기</h1>
  <p class="note">※ 게임이 원활하지 않을 시 펀치 속도를 줄이거나 다시 시작을 누르세요.</p>
  
  <p>펀치 횟수: <span id="count">0</span></p>
  <img id="enemy" src="images/clean.png">
  <br>
  <button onclick="resetGame()">다시 시작</button>
  <p id="message"></p>

  <div id="ranking">
    <h2>🏆 TOP 10 랭킹 🏆</h2>
    <table id="rankingTable">
      <thead>
        <tr>
          <th>순위</th>
          <th>기록</th>
          <th>이니셜</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="close" onclick="closeRanking()">닫기</div>
  </div>

  <audio id="punchsound" src="sounds/punchsound.wav"></audio>
  <audio id="hitsound1" src="sounds/hitsound1.wav"></audio>
  <audio id="hitsound2" src="sounds/hitsound2.wav"></audio>
  <audio id="hitsound3" src="sounds/hitsound3.wav"></audio>

  <!-- ★ 1. Firebase SDK 추가 -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // ★ 2. Firebase 구성 (본인 프로젝트 설정으로 대체)
    const firebaseConfig = {
      apiKey: "AIzaSyAZtWpPgmhr5sKY3lIyzYf1sreyF7SzhcU",
      authDomain: "punchgyogaserver.firebaseapp.com",
      databaseURL: "https://punchgyogaserver-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "punchgyogaserver",
      storageBucket: "punchgyogaserver.firebasestorage.app",
      messagingSenderId: "551738104836",
      appId: "1:551738104836:web:f0e1d90e748ddb8740a951",
      measurementId: "G-FMP1XFT90H"
    };
    firebase.initializeApp(firebaseConfig);

    // ★ 3. 기존 변수 유지
    let count = 0;
    let startTime = null;
    let endTime = null;
    const enemy = document.getElementById("enemy");
    const countText = document.getElementById("count");
    const message = document.getElementById("message");
    const rankingTable = document.getElementById("rankingTable").getElementsByTagName('tbody')[0];

    // ★ 4. Firebase 연동 함수
    async function saveRecord(elapsed, initials) {
      const db = firebase.database();
      await db.ref('records').push({
        time: elapsed,
        initials: initials,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function loadRecords() {
      const db = firebase.database();
      db.ref('records')
        .orderByChild('time')
        .limitToLast(10)
        .once('value', (snapshot) => {
          const records = [];
          snapshot.forEach((child) => {
            records.push(child.val());
          });
          displayRecords(records.reverse());
        });
    }

    function displayRecords(records) {
      rankingTable.innerHTML = '';
      records.forEach((record, index) => {
        const row = rankingTable.insertRow();
        row.insertCell(0).textContent = index + 1;
        row.insertCell(1).textContent = record.time.toFixed(2) + '초';
        row.insertCell(2).textContent = record.initials || '익명';
      });
    }

    // ★ 5. punch() 함수 수정 (async 추가)
    async function punch() {
      if (count >= 10) return;
      if (count === 0) startTime = performance.now();

      count++;
      countText.innerText = count;

      document.getElementById("punchsound").play();

      const randSide = Math.random() < 0.5 ? 'L' : 'R';
      let state = '';

      if (count >= 10) {
        endTime = performance.now();
        const elapsed = (endTime - startTime) / 1000;

        // ★ Firebase에 기록 저장
        const initials = prompt(`🎉 ${elapsed.toFixed(2)}초 기록!\n이니셜 입력 (영문 3자):`);
        if (initials) {
          await saveRecord(elapsed, initials.substring(0, 3).toUpperCase());
          loadRecords();
        }

        message.innerHTML = `기록: ${elapsed.toFixed(2)}초<br>
                           <a href="https://youtu.be/88hvuiZewfA" target="_blank" style="color: yellow;">▶ 명반 [엽기] 들으러 가기</a>`;
        enemy.src = 'images/over.png';
        return;
      }
      // ... (기존 애니메이션 로직 유지)
    }

    // ★ 6. 페이지 로드 시 랭킹 불러오기
    window.onload = function() {
      loadRecords();
    };

    // 기존 함수들 유지
    function closeRanking() {
      document.getElementById("ranking").style.display = 'none';
    }

    function resetGame() {
      count = 0;
      startTime = null;
      countText.innerText = count;
      message.innerText = "";
      enemy.src = 'images/clean.png';
    }

    enemy.addEventListener('click', punch);
  </script>
</body>
</html>
